# 构建部署流程

## 1. 构建部署概述

本文档详细描述了 `charm-experimental-packages-cn` 项目的构建和部署流程，包括环境配置、构建步骤、部署流程和环境变量配置等。遵循这些流程可以确保项目的正确构建和部署，提高开发和运维效率。

## 2. 环境配置

### 2.1 系统要求

| 组件 | 版本/要求 | 说明 |
|------|----------|------|
| 操作系统 | Linux, macOS, Windows | 支持主流操作系统 |
| Go 语言 | 1.24.2 或更高版本 | 项目的主要开发语言 |
| Git | 2.0 或更高版本 | 版本控制工具 |
| 终端 | 支持 ANSI 转义序列的终端 | 用于测试终端相关功能 |

### 2.2 Go 环境配置

1. **安装 Go**
   - 从 [Go 官方网站](https://golang.org/dl/) 下载并安装适合您操作系统的 Go 版本
   - 验证安装是否成功：
     ```bash
     go version
     ```

2. **设置 GOPATH**
   - Go 1.11+ 版本推荐使用 Go Modules，不需要设置 GOPATH
   - 但如果需要，可以设置 GOPATH 环境变量：
     ```bash
     # Linux/macOS
     export GOPATH=$HOME/go
     
     # Windows
     set GOPATH=%USERPROFILE%\go
     ```

3. **设置 GOROOT**
   - Go 安装程序通常会自动设置 GOROOT
   - 验证 GOROOT 是否正确：
     ```bash
     go env GOROOT
     ```

4. **添加 Go 二进制目录到 PATH**
   - 确保 Go 的二进制目录在 PATH 中：
     ```bash
     # Linux/macOS
     export PATH=$PATH:$GOROOT/bin:$GOPATH/bin
     
     # Windows
     set PATH=%PATH%;%GOROOT%\bin;%GOPATH%\bin
     ```

### 2.3 依赖管理

`charm-experimental-packages-cn` 项目使用 Go Modules 进行依赖管理。每个模块都有自己的 `go.mod` 文件，定义了模块的依赖关系。

1. **初始化 Go 模块**
   - 如果需要创建新模块，使用以下命令初始化：
     ```bash
     go mod init github.com/purpose168/charm-experimental-packages-cn/[模块名]
     ```

2. **添加依赖**
   - 使用以下命令添加依赖：
     ```bash
     go get [依赖包路径]
     ```

3. **更新依赖**
   - 使用以下命令更新依赖：
     ```bash
     go get -u [依赖包路径]
     ```

4. **整理依赖**
   - 使用以下命令整理依赖：
     ```bash
     go mod tidy
     ```

5. **查看依赖**
   - 使用以下命令查看模块的依赖：
     ```bash
     go list -m all
     ```

## 3. 构建流程

### 3.1 构建单个模块

1. **进入模块目录**
   ```bash
   cd [模块目录]
   ```

2. **构建模块**
   ```bash
   go build ./...
   ```

3. **运行测试**
   ```bash
   go test ./...
   ```

4. **安装模块**
   ```bash
   go install ./...
   ```

### 3.2 构建所有模块

1. **进入项目根目录**
   ```bash
   cd /home/pps/github/kunwu-agents/charm-experimental-packages-cn
   ```

2. **构建所有模块**
   ```bash
   for dir in */; do
     if [ -f "$dir/go.mod" ]; then
       echo "构建模块: $dir"
       cd "$dir"
       go build ./...
       cd ..
     fi
   done
   ```

3. **运行所有测试**
   ```bash
   for dir in */; do
     if [ -f "$dir/go.mod" ]; then
       echo "测试模块: $dir"
       cd "$dir"
       go test ./...
       cd ..
     fi
   done
   ```

### 3.3 构建选项

Go 构建命令支持多种选项，可以根据需要使用：

| 选项 | 说明 | 示例 |
|------|------|------|
| `-o` | 指定输出文件名 | `go build -o myapp` |
| `-ldflags` | 传递链接器标志 | `go build -ldflags "-X main.Version=1.0.0"` |
| `-tags` | 构建标签 | `go build -tags debug` |
| `-race` | 启用竞态检测 | `go build -race` |
| `-v` | 显示详细信息 | `go build -v` |

## 4. 部署流程

### 4.1 本地开发部署

1. **克隆仓库**
   ```bash
   git clone https://github.com/purpose168/charm-experimental-packages-cn.git
   cd charm-experimental-packages-cn
   ```

2. **安装依赖**
   ```bash
   for dir in */; do
     if [ -f "$dir/go.mod" ]; then
       cd "$dir"
       go mod tidy
       cd ..
     fi
   done
   ```

3. **构建模块**
   ```bash
   for dir in */; do
     if [ -f "$dir/go.mod" ]; then
       cd "$dir"
       go build ./...
       cd ..
     fi
   done
   ```

4. **运行测试**
   ```bash
   for dir in */; do
     if [ -f "$dir/go.mod" ]; then
       cd "$dir"
       go test ./...
       cd ..
     fi
   done
   ```

5. **使用模块**
   - 在您的项目中导入需要的模块：
     ```go
     import (
       "github.com/purpose168/charm-experimental-packages-cn/[模块名]"
     )
     ```

### 4.2 作为依赖部署

1. **在项目中添加依赖**
   ```bash
   go get github.com/purpose168/charm-experimental-packages-cn/[模块名]
   ```

2. **更新依赖**
   ```bash
   go mod tidy
   ```

3. **构建项目**
   ```bash
   go build ./...
   ```

### 4.3 持续集成/持续部署 (CI/CD)

如果需要设置 CI/CD 流程，可以使用以下配置作为参考：

#### 4.3.1 GitHub Actions 配置

```yaml
name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.24.2'
    
    - name: Build all modules
      run: |
        for dir in */; do
          if [ -f "$dir/go.mod" ]; then
            echo "Building module: $dir"
            cd "$dir"
            go build ./...
            cd ..
          fi
        done
    
    - name: Test all modules
      run: |
        for dir in */; do
          if [ -f "$dir/go.mod" ]; then
            echo "Testing module: $dir"
            cd "$dir"
            go test ./...
            cd ..
          fi
        done
```

#### 4.3.2 GitLab CI 配置

```yaml
stages:
  - build
  - test

variables:
  GO_VERSION: "1.24.2"

build:
  stage: build
  image: golang:$GO_VERSION
  script:
    - for dir in */; do
        if [ -f "$dir/go.mod" ]; then
          echo "Building module: $dir"
          cd "$dir"
          go build ./...
          cd ..
        fi
      done

 test:
  stage: test
  image: golang:$GO_VERSION
  script:
    - for dir in */; do
        if [ -f "$dir/go.mod" ]; then
          echo "Testing module: $dir"
          cd "$dir"
          go test ./...
          cd ..
        fi
      done
```

## 5. 环境变量配置

### 5.1 通用环境变量

| 环境变量 | 说明 | 默认值 |
|----------|------|--------|
| `GOPATH` | Go 工作目录 | `$HOME/go` (Linux/macOS) 或 `%USERPROFILE%\go` (Windows) |
| `GOROOT` | Go 安装目录 | 取决于安装位置 |
| `GO111MODULE` | Go 模块模式 | `auto` |
| `GOPROXY` | Go 代理设置 | `https://proxy.golang.org,direct` |

### 5.2 项目特定环境变量

| 环境变量 | 说明 | 默认值 | 模块 |
|----------|------|--------|------|
| `TERM` | 终端类型 | 取决于终端 | 所有终端相关模块 |
| `TERM_PROGRAM` | 终端程序 | 取决于终端 | 所有终端相关模块 |
| `COLORTERM` | 颜色终端支持 | 取决于终端 | colors |
| `NO_COLOR` | 禁用颜色 | 未设置 | colors |

### 5.3 开发环境变量

| 环境变量 | 说明 | 默认值 | 用途 |
|----------|------|--------|------|
| `DEBUG` | 启用调试模式 | 未设置 | 所有模块 |
| `VERBOSE` | 启用详细输出 | 未设置 | 所有模块 |
| `TEST_MODE` | 测试模式 | 未设置 | 测试 |

## 6. 跨平台构建

### 6.1 构建不同操作系统的二进制文件

Go 支持交叉编译，可以在一个平台上构建其他平台的二进制文件：

| 目标平台 | GOOS | GOARCH | 示例命令 |
|----------|------|--------|----------|
| Linux | linux | amd64 | `GOOS=linux GOARCH=amd64 go build` |
| Linux | linux | arm64 | `GOOS=linux GOARCH=arm64 go build` |
| macOS | darwin | amd64 | `GOOS=darwin GOARCH=amd64 go build` |
| macOS | darwin | arm64 | `GOOS=darwin GOARCH=arm64 go build` |
| Windows | windows | amd64 | `GOOS=windows GOARCH=amd64 go build` |
| Windows | windows | 386 | `GOOS=windows GOARCH=386 go build` |

### 6.2 构建脚本示例

以下是一个构建脚本示例，可以构建多个平台的二进制文件：

```bash
#!/bin/bash

# 构建脚本

MODULES="ansi cellbuf colors input term"
PLATFORMS="linux/amd64 linux/arm64 darwin/amd64 darwin/arm64 windows/amd64"

for module in $MODULES; do
  echo "构建模块: $module"
  cd "$module"
  
  for platform in $PLATFORMS; do
    IFS=/ read -r GOOS GOARCH <<< "$platform"
    output_dir="../build/$module/$GOOS-$GOARCH"
    mkdir -p "$output_dir"
    
    echo "  构建 $GOOS/$GOARCH"
    GOOS=$GOOS GOARCH=$GOARCH go build -o "$output_dir/"
  done
  
  cd ..
done

echo "构建完成！"
```

## 7. 容器化部署

### 7.1 Docker 构建

如果需要将项目容器化，可以使用以下 Dockerfile 作为参考：

```dockerfile
FROM golang:1.24.2-alpine AS builder

WORKDIR /app

COPY . .

RUN apk add --no-cache git

# 构建所有模块
RUN for dir in */; do \
    if [ -f "$dir/go.mod" ]; then \
      cd "$dir" && \
      go mod tidy && \
      go build ./... && \
      cd ..; \
    fi \
done

FROM alpine:latest

WORKDIR /app

COPY --from=builder /app /app

# 安装必要的依赖
RUN apk add --no-cache \
    ca-certificates \
    tzdata

# 设置环境变量
ENV TZ=UTC

CMD ["/bin/sh"]
```

### 7.2 构建和运行 Docker 容器

```bash
# 构建 Docker 镜像
docker build -t charm-experimental-packages-cn .

# 运行 Docker 容器
docker run -it --rm charm-experimental-packages-cn
```

## 8. 故障排查

### 8.1 构建错误

| 错误 | 可能原因 | 解决方案 |
|------|----------|----------|
| `go: command not found` | Go 未安装或未在 PATH 中 | 安装 Go 并添加到 PATH |
| `package not found` | 依赖未安装 | 运行 `go mod tidy` |
| `version mismatch` | Go 版本不兼容 | 使用项目要求的 Go 版本 |
| `build constraints exclude all Go files` | 构建标签不匹配 | 检查构建标签设置 |

### 8.2 部署错误

| 错误 | 可能原因 | 解决方案 |
|------|----------|----------|
| `import cycle not allowed` | 导入循环 | 重构代码，打破循环依赖 |
| `undefined reference` | 符号未定义 | 检查依赖是否正确安装 |
| `permission denied` | 权限不足 | 检查文件权限 |
| `connection refused` | 网络连接问题 | 检查网络连接和代理设置 |

### 8.3 运行时错误

| 错误 | 可能原因 | 解决方案 |
|------|----------|----------|
| `terminal entry not found` | 终端类型不支持 | 检查 TERM 环境变量 |
| `unsupported terminal` | 终端功能不支持 | 使用支持的终端或提供降级方案 |
| `color not supported` | 终端不支持颜色 | 检查 COLORTERM 环境变量 |
| `input not available` | 标准输入不可用 | 确保在支持输入的环境中运行 |

## 9. 最佳实践

### 9.1 构建最佳实践

1. **使用 Go Modules**：始终使用 Go Modules 进行依赖管理
2. **版本锁定**：使用 `go.sum` 文件锁定依赖版本，确保构建一致性
3. **缓存依赖**：在 CI/CD 环境中缓存依赖，加快构建速度
4. **使用构建标签**：使用构建标签区分不同环境的构建
5. **优化构建**：使用 `-ldflags "-s -w"` 减小二进制文件大小

### 9.2 部署最佳实践

1. **自动化部署**：使用 CI/CD 工具自动化部署流程
2. **环境隔离**：为不同环境（开发、测试、生产）使用不同的配置
3. **监控和日志**：添加监控和日志记录，便于排查问题
4. **回滚策略**：制定部署失败的回滚策略
5. **文档更新**：部署后更新相关文档，记录部署信息

### 9.3 依赖管理最佳实践

1. **定期更新依赖**：定期更新依赖，修复安全漏洞
2. **审查依赖**：审查新增依赖，确保其安全性和可靠性
3. **最小化依赖**：只添加必要的依赖，避免依赖膨胀
4. **使用固定版本**：使用固定版本的依赖，避免意外的 breaking changes
5. **检查依赖漏洞**：使用工具检查依赖中的安全漏洞

## 10. 总结

`charm-experimental-packages-cn` 项目的构建和部署流程相对简单，主要依赖于 Go 语言的标准工具链。通过遵循本文档中的流程和最佳实践，可以确保项目的正确构建和部署，提高开发和运维效率。

随着项目的不断发展和技术的不断演进，构建和部署流程也可能需要调整和优化。开发者应关注 Go 语言和相关工具的更新，及时调整构建和部署策略，以适应项目的发展需求。