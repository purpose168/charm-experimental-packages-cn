# 开发规范

## 1. 规范概述

本文档定义了 `charm-experimental-packages-cn` 项目的开发规范，包括编码规范、命名规范、代码审查标准及文档编写规范等。遵循这些规范有助于保持代码的一致性、可读性和可维护性，提高开发效率和代码质量。

## 2. 编码规范

### 2.1 Go 语言编码规范

#### 2.1.1 基本规范

- **代码风格**：遵循 [Go Code Review Comments](https://github.com/golang/go/wiki/CodeReviewComments) 中的代码风格建议
- **缩进**：使用 4 个空格进行缩进，不使用制表符
- **行宽**：每行代码不超过 100 个字符，便于阅读和代码审查
- **空行**：在函数之间、逻辑块之间使用空行分隔，提高代码可读性
- **括号**：使用 Go 语言的惯用括号风格，如 `if`、`for`、`switch` 等语句的括号

#### 2.1.2 包规范

- **包名**：使用小写字母，简短且能描述包的功能，避免使用下划线
- **包导入**：按标准库、第三方库、本地库的顺序导入，不同类别之间使用空行分隔
- **包初始化**：如果需要，使用 `init()` 函数进行包初始化，但应避免在 `init()` 中执行复杂操作

#### 2.1.3 函数规范

- **函数名**：使用 PascalCase 命名法，函数名应能清晰描述函数的功能
- **函数长度**：单个函数长度不宜过长，建议不超过 50 行，复杂功能应拆分为多个函数
- **参数和返回值**：参数和返回值应使用有意义的名称，避免使用单字母变量名
- **错误处理**：函数应返回错误信息，调用者应检查并适当处理错误
- **注释**：为每个导出函数提供文档注释，描述函数的功能、参数、返回值和使用方法

#### 2.1.4 变量和常量规范

- **变量名**：使用 camelCase 命名法，变量名应能清晰描述变量的用途
- **常量名**：使用 ALL_CAPS 命名法，单词之间使用下划线分隔
- **变量声明**：使用 `var` 声明多个变量，使用 `:=` 进行简短变量声明
- **零值**：使用 Go 语言的零值（如 `nil`、`0`、`""`），避免使用 `NULL` 或其他语言的空值表示

#### 2.1.5 类型规范

- **类型名**：使用 PascalCase 命名法，类型名应能清晰描述类型的用途
- **结构体**：结构体字段使用 camelCase 命名法，导出字段首字母大写
- **接口**：接口名使用 PascalCase 命名法，通常以 `er` 结尾（如 `Reader`、`Writer`）
- **类型定义**：为复杂类型创建类型定义，提高代码可读性和可维护性

### 2.2 终端相关编码规范

#### 2.2.1 输入处理规范

- **输入事件**：使用 `input` 模块的事件系统处理终端输入，避免直接操作标准输入
- **键盘快捷键**：为常用操作定义合理的键盘快捷键，遵循终端应用的常见约定
- **鼠标支持**：如果需要，添加鼠标支持，但应确保在不支持鼠标的终端中也能正常工作
- **输入验证**：对用户输入进行验证，避免因无效输入导致程序崩溃

#### 2.2.2 显示处理规范

- **缓冲区操作**：使用 `cellbuf` 模块的缓冲区进行终端显示操作，避免直接输出 ANSI 转义序列
- **ANSI 转义序列**：如果需要直接使用 ANSI 转义序列，应使用 `ansi` 模块的常量和函数，确保跨终端兼容性
- **颜色使用**：使用 `colors` 模块处理颜色，避免硬编码颜色值，确保在不同终端中的显示效果一致
- **终端大小**：在启动时和收到调整大小事件时获取终端大小，确保界面适应不同大小的终端

#### 2.2.3 跨平台兼容规范

- **平台检测**：使用 `runtime.GOOS` 检测操作系统类型，为不同平台提供适当的实现
- **文件路径**：使用 `path/filepath` 包处理文件路径，避免硬编码路径分隔符
- **系统调用**：使用 `golang.org/x/sys` 包进行系统调用，确保跨平台兼容性
- **终端特性**：检测终端特性（如颜色支持、鼠标支持），提供降级方案

## 3. 命名规范

### 3.1 通用命名规范

- **一致性**：在整个项目中保持命名风格的一致性
- **可读性**：使用清晰、描述性的名称，避免使用缩写和简写
- **长度**：名称长度应适中，既不过长也不过短，平衡可读性和简洁性
- **避免冲突**：避免使用与 Go 标准库或常用第三方库冲突的名称

### 3.2 包命名规范

- **小写字母**：包名使用小写字母，不使用大写字母或下划线
- **简短明了**：包名应简短明了，能描述包的主要功能
- **避免复数**：除非包名表示的是集合，否则应使用单数形式
- **避免使用通用名称**：避免使用 `util`、`common`、`helper` 等过于通用的名称

### 3.3 类型命名规范

- **PascalCase**：类型名使用 PascalCase 命名法
- **名词**：类型名通常使用名词或名词短语
- **清晰描述**：类型名应清晰描述类型的用途和特点
- **接口命名**：接口名通常以 `er` 结尾，表示该接口的实现者具有某种能力

### 3.4 函数命名规范

- **PascalCase**：函数名使用 PascalCase 命名法
- **动词或动词短语**：函数名通常使用动词或动词短语，描述函数的行为
- **清晰描述**：函数名应清晰描述函数的功能和行为
- **避免使用通用动词**：避免使用 `Do`、`Process` 等过于通用的动词

### 3.5 变量命名规范

- **camelCase**：变量名使用 camelCase 命名法
- **描述性**：变量名应能描述变量的用途和含义
- **简短**：对于作用域较小的变量，可以使用更简短的名称
- **避免单字母变量**：除非是循环变量或数学公式中的变量，否则应避免使用单字母变量名

### 3.6 常量命名规范

- **ALL_CAPS**：常量名使用 ALL_CAPS 命名法，单词之间使用下划线分隔
- **描述性**：常量名应能描述常量的用途和含义
- **分组**：相关常量应分组定义，使用注释或常量块进行组织

### 3.7 文件命名规范

- **小写字母**：文件名使用小写字母，单词之间使用下划线分隔
- **描述性**：文件名应能描述文件的内容和用途
- **与包名一致**：主文件的文件名应与包名一致
- **避免使用通用名称**：避免使用 `main.go`、`util.go` 等过于通用的名称

## 4. 代码审查标准

### 4.1 代码审查流程

1. **提交前自检**：开发者在提交代码前应自行检查代码是否符合规范
2. **创建拉取请求**：开发者创建拉取请求，描述代码变更的目的和内容
3. **代码审查**：代码审查者审查代码，检查是否符合规范和质量要求
4. **反馈和修改**：代码审查者提供反馈，开发者根据反馈进行修改
5. **合并**：代码审查通过后，将代码合并到主分支

### 4.2 代码审查标准

#### 4.2.1 功能正确性

- **功能实现**：代码是否正确实现了预期功能
- **边界情况**：是否处理了边界情况和异常情况
- **错误处理**：是否正确处理了错误，避免错误被忽略或处理不当
- **逻辑一致性**：代码逻辑是否一致，是否存在逻辑矛盾或漏洞

#### 4.2.2 代码质量

- **可读性**：代码是否易于阅读和理解
- **可维护性**：代码是否易于维护和扩展
- **性能**：代码是否存在性能问题，是否有优化空间
- **安全性**：代码是否存在安全隐患，如缓冲区溢出、注入攻击等

#### 4.2.3 规范遵循

- **编码规范**：代码是否符合项目的编码规范
- **命名规范**：变量、函数、类型等命名是否符合规范
- **文档规范**：是否提供了必要的文档和注释
- **测试规范**：是否编写了测试代码，测试覆盖率是否足够

#### 4.2.4 依赖管理

- **依赖版本**：依赖版本是否合理，是否有安全漏洞
- **依赖必要性**：新增依赖是否必要，是否可以使用标准库或现有依赖替代
- **依赖冲突**：是否存在依赖冲突或版本不兼容问题

### 4.3 代码审查工具

- **go vet**：检查代码中的常见错误和问题
- **golint**：检查代码是否符合 Go 语言的编码规范
- **staticcheck**：进行更全面的静态代码分析
- **测试覆盖率工具**：检查测试覆盖率，确保代码被充分测试

## 5. 文档编写规范

### 5.1 代码文档

#### 5.1.1 包文档

- **位置**：每个包的主文件顶部应包含包文档
- **内容**：描述包的功能、用途和使用方法
- **格式**：使用 Markdown 格式编写包文档
- **示例**：提供使用示例，帮助开发者快速上手

#### 5.1.2 函数文档

- **位置**：每个导出函数的上方应包含函数文档
- **内容**：描述函数的功能、参数、返回值和使用方法
- **格式**：使用 Markdown 格式编写函数文档
- **参数和返回值**：清晰描述每个参数的含义和每个返回值的意义
- **错误处理**：描述函数可能返回的错误及其原因

#### 5.1.3 类型文档

- **位置**：每个导出类型的上方应包含类型文档
- **内容**：描述类型的用途、特点和使用方法
- **格式**：使用 Markdown 格式编写类型文档
- **字段**：如果是结构体，应描述每个字段的含义和用途

### 5.2 项目文档

#### 5.2.1 README.md

- **位置**：项目根目录应包含 README.md 文件
- **内容**：描述项目的简介、功能、安装方法、使用示例和贡献指南等
- **格式**：使用 Markdown 格式编写 README.md
- **语言**：使用清晰、简洁的语言，避免使用复杂的术语

#### 5.2.2 架构文档

- **位置**：项目文档目录应包含架构文档
- **内容**：描述项目的架构设计、模块划分、依赖关系和数据流等
- **格式**：使用 Markdown 格式编写架构文档
- **图表**：使用 Mermaid 等工具绘制架构图和流程图，提高文档的可读性

#### 5.2.3 API 文档

- **位置**：项目文档目录应包含 API 文档
- **内容**：描述项目的 API 接口、参数、返回值和使用方法等
- **格式**：使用 Markdown 格式编写 API 文档
- **示例**：提供 API 使用示例，帮助开发者理解如何使用 API

### 5.3 文档风格

- **语言**：使用简洁、清晰的语言，避免使用复杂的术语
- **格式**：使用 Markdown 格式编写文档，遵循 Markdown 语法规范
- **标题**：使用适当的标题层级，组织文档结构
- **代码块**：使用代码块展示代码示例，指定代码语言
- **链接**：使用链接引用相关文档和资源
- **图片**：使用图片和图表增强文档的可读性

## 6. 测试规范

### 6.1 测试类型

- **单元测试**：测试单个函数或方法的功能
- **集成测试**：测试多个模块或组件的集成功能
- **端到端测试**：测试整个应用的功能和流程

### 6.2 测试编写规范

- **测试文件**：测试文件应与被测试文件在同一目录，文件名以 `_test.go` 结尾
- **测试函数**：测试函数名应以 `Test` 开头，使用 PascalCase 命名法
- **测试覆盖**：测试应覆盖主要功能和边界情况
- **测试隔离**：测试应相互隔离，避免测试之间的依赖
- **测试断言**：使用 `testing` 包或 `testify` 库进行测试断言

### 6.3 测试工具

- **go test**：使用 Go 标准库的测试工具运行测试
- **测试覆盖率**：使用 `-cover` 标志运行测试，检查测试覆盖率
- **基准测试**：使用基准测试评估代码性能
- **模糊测试**：使用模糊测试发现潜在的边界情况和漏洞

## 7. 版本控制规范

### 7.1 分支管理

- **主分支**：`main` 分支是稳定的主分支，用于发布版本
- **开发分支**：`develop` 分支是开发分支，用于集成新功能
- **特性分支**：从 `develop` 分支创建特性分支，用于开发新功能
- **修复分支**：从 `main` 分支创建修复分支，用于修复 bug

### 7.2 提交规范

- **提交信息**：提交信息应清晰描述代码变更的目的和内容
- **提交粒度**：每个提交应专注于单一功能或修复，避免混合多个不相关的变更
- **提交格式**：使用以下格式编写提交信息：
  ```
  <类型>: <描述>
  
  <详细描述>
  ```
  其中类型可以是：`feat`（新功能）、`fix`（修复 bug）、`docs`（文档）、`style`（代码风格）、`refactor`（重构）、`test`（测试）、`chore`（构建或依赖更新）

### 7.3 版本号规范

- **版本号格式**：使用语义化版本号格式 `MAJOR.MINOR.PATCH`
- **MAJOR**：当进行不兼容的 API 变更时增加
- **MINOR**：当添加向后兼容的新功能时增加
- **PATCH**：当进行向后兼容的 bug 修复时增加
- **预发布版本**：使用 `-alpha`、`-beta`、`-rc` 等后缀标识预发布版本

## 8. 代码质量工具

### 8.1 静态分析工具

- **go vet**：检查代码中的常见错误和问题
- **golint**：检查代码是否符合 Go 语言的编码规范
- **staticcheck**：进行更全面的静态代码分析，发现潜在问题
- **errcheck**：检查是否有未处理的错误

### 8.2 代码格式化工具

- **gofmt**：使用 Go 语言的标准格式化工具格式化代码
- **goimports**：自动整理和格式化包导入

### 8.3 性能分析工具

- **pprof**：Go 语言的性能分析工具，用于分析 CPU 和内存使用情况
- **benchstat**：用于比较基准测试结果

## 9. 开发工作流

### 9.1 开发环境设置

- **Go 版本**：使用项目指定的 Go 版本，建议使用 `go.mod` 文件管理依赖
- **编辑器配置**：配置编辑器使用项目的编码规范，如缩进、行宽等
- **工具安装**：安装必要的开发工具，如静态分析工具、代码格式化工具等

### 9.2 开发流程

1. **需求分析**：分析需求，理解功能要求和技术实现
2. **设计**：设计代码结构和实现方案
3. **编码**：按照编码规范编写代码
4. **测试**：编写测试代码，确保功能正确
5. **代码审查**：提交代码进行审查
6. **修改**：根据代码审查反馈进行修改
7. **合并**：代码审查通过后，将代码合并到主分支

### 9.3 发布流程

1. **版本规划**：规划发布版本，确定版本号
2. **测试**：运行全面测试，确保功能正常
3. **文档更新**：更新项目文档，包括 README.md 和 API 文档
4. **版本标记**：创建版本标记，如 `v1.0.0`
5. **发布**：发布版本，更新发布说明

## 10. 总结

`charm-experimental-packages-cn` 项目的开发规范旨在确保代码的一致性、可读性和可维护性，提高开发效率和代码质量。遵循这些规范有助于开发者更好地理解和使用项目，也有助于项目的长期发展和维护。

随着项目的不断发展和技术的不断演进，这些规范也会不断更新和完善。开发者应关注规范的更新，及时调整自己的开发实践，以适应项目的发展需求。